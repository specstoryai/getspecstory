name: Release CLI

on:
  push:
    tags:
      - 'specstory-cli/v*'

permissions:
  contents: write

jobs:
  goreleaser:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-go@v4
        with:
          go-version: '1.21'
      - name: Extract version from tag
        id: version
        run: echo "version=${GITHUB_REF_NAME#specstory-cli/}" >> $GITHUB_OUTPUT

      - uses: goreleaser/goreleaser-action@v6
        with:
          version: "~> v2"
          args: release --clean --skip=validate
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          POSTHOG_API_KEY: ${{ secrets.POSTHOG_API_KEY }}
          GORELEASER_CURRENT_TAG: ${{ steps.version.outputs.version }}

      - name: Collect release details
        id: release_details
        continue-on-error: true
        run: |
            # Extract version from git tag (github.ref_name will be like "specstory-cli/v1.0.0")
            VERSION="${{ github.ref_name }}"
            VERSION="${VERSION#specstory-cli/}"  # Strip the subdirectory prefix
            # Extract changelog for this version from specstory-cli/changelog.md
            # The changelog format is: ## v0.13.0 2025-10-26
            CHANGELOG=$(awk -v version="$VERSION" 'BEGIN{p=0} /^## /{if ($0 ~ "^## " version){p=1; next} else if (p==1 && /^## /){exit}} p==1{print}' specstory-cli/changelog.md)
            {
              echo "version=$VERSION"
              echo "changelog<<CHANGELOG_EOF"
              echo "$CHANGELOG"
              echo "CHANGELOG_EOF"
            } >> "$GITHUB_OUTPUT"

      - name: Update release notes with changelog
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          CHANGELOG=$(awk -v version="$VERSION" 'BEGIN{p=0} /^## /{if ($0 ~ "^## " version){p=1; next} else if (p==1 && /^## /){exit}} p==1{print}' specstory-cli/changelog.md)
          if [ -n "$CHANGELOG" ]; then
            gh release edit "$VERSION" --notes "$CHANGELOG"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Notify Slack (#clients)
        env:
            SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL_CLIENTS }}
            VERSION: ${{ steps.release_details.outputs.version || 'unknown version' }}
            CHANGELOG: ${{ steps.release_details.outputs.changelog || 'failed collecting release details' }}
        run: |
            {
              printf "\n\nChangelog:\n%s\n" "$CHANGELOG"
            } > message.txt

            TITLE="*CLI $VERSION released*"
            jq -n \
              --rawfile text message.txt \
              --arg title "$TITLE" \
              --arg username "SpecStory Release Bot" \
              --arg icon ":specstory:" \
              '{
                username: $username,
                icon_emoji: $icon,
                attachments: [
                  {
                    color: "#e35a2c",
                    blocks: [
                      {
                        "type": "section",
                        "text": { "type": "mrkdwn", "text": $title }
                      },
                      {
                        "type": "section",
                        "text": { "type": "mrkdwn", "text": $text }
                      }
                    ]
                  }
                ]
              }' > payload.json
            curl -X POST -H 'Content-type: application/json' --data @payload.json "$SLACK_WEBHOOK_URL"

  update-homebrew-tap:
    needs: [goreleaser]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: |
          VERSION="${GITHUB_REF_NAME#specstory-cli/v}"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Download release artifacts
        run: |
          mkdir -p dist
          gh release download "v${{ steps.version.outputs.version }}" --pattern "SpecStoryCLI_*.tar.gz" --dir dist
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Compute SHA256 hashes
        id: hashes
        run: |
          echo "darwin_arm64=$(shasum -a 256 dist/SpecStoryCLI_Darwin_arm64.tar.gz | cut -d' ' -f1)" >> "$GITHUB_OUTPUT"
          echo "darwin_x86_64=$(shasum -a 256 dist/SpecStoryCLI_Darwin_x86_64.tar.gz | cut -d' ' -f1)" >> "$GITHUB_OUTPUT"
          echo "linux_arm64=$(shasum -a 256 dist/SpecStoryCLI_Linux_arm64.tar.gz | cut -d' ' -f1)" >> "$GITHUB_OUTPUT"
          echo "linux_x86_64=$(shasum -a 256 dist/SpecStoryCLI_Linux_x86_64.tar.gz | cut -d' ' -f1)" >> "$GITHUB_OUTPUT"

      - name: Checkout homebrew-tap
        uses: actions/checkout@v4
        with:
          repository: specstoryai/homebrew-tap
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: homebrew-tap

      - name: Update formula
        run: |
          ./scripts/update-homebrew-formula.sh \
            homebrew-tap/Formula/specstory.rb \
            "${{ steps.version.outputs.version }}" \
            "${{ steps.hashes.outputs.darwin_arm64 }}" \
            "${{ steps.hashes.outputs.darwin_x86_64 }}" \
            "${{ steps.hashes.outputs.linux_arm64 }}" \
            "${{ steps.hashes.outputs.linux_x86_64 }}"

      - name: Commit and push
        run: |
          cd homebrew-tap
          git config user.name "specstory-bot"
          git config user.email "actions@github.com"
          git add Formula/specstory.rb
          git commit -m "Release specstory v${{ steps.version.outputs.version }}"
          git push
